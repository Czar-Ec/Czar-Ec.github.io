name: Deploy to live CD portfolio
on:
  push:
    branches: [develop]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # Install dependencies
      - run: yarn install

      # Run tests with coverage
      - run: yarn test:ci

      # Build production with correct base href for GitHub Pages
      - name: Build production
        run: |
          yarn build:prod

      # -------------------------------
      # Extract overall coverage
      # -------------------------------
      - name: Get coverage percentage
        id: coverage
        run: |
          LCOV_PATH=$(find coverage -type f -name lcov.info | head -n 1)
          if [ -z "$LCOV_PATH" ]; then
            echo "No lcov.info found, setting coverage=0"
            echo "coverage=0" >> $GITHUB_OUTPUT
          else
            COVERAGE=$(grep -A 1 "TOTAL" "$LCOV_PATH" | grep -oP "(?<=\s)\d+(?=\.\d+%)" | tail -1)
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      # -------------------------------
      # Generate coverage badge
      # -------------------------------
      - name: Generate coverage badge
        run: |
          mkdir -p badges
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          if [ -z "$COVERAGE" ]; then COVERAGE=0; fi

          COLOR=red
          if [ "$COVERAGE" -ge 90 ]; then COLOR=brightgreen
          elif [ "$COVERAGE" -ge 85 ]; then COLOR=green
          elif [ "$COVERAGE" -ge 80 ]; then COLOR=yellow
          else COLOR=red
          fi

          echo "Generating badge for coverage ${COVERAGE}% ($COLOR)"
          curl -s -o badges/coverage.svg "https://img.shields.io/badge/coverage-${COVERAGE}%25-${COLOR}"

      # -------------------------------
      # Commit badge safely
      # -------------------------------
      - name: Commit coverage badge to coverage-badges branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Move badge to temp to avoid branch conflict
          mkdir -p /tmp/badges
          cp badges/coverage.svg /tmp/badges/coverage.svg

          git fetch origin

          if git rev-parse --verify origin/coverage-badges >/dev/null 2>&1; then
            git fetch origin coverage-badges
            git checkout -B coverage-badges origin/coverage-badges
          else
            git checkout --orphan coverage-badges
            git rm -rf . >/dev/null 2>&1 || true
          fi

          mkdir -p badges
          cp /tmp/badges/coverage.svg badges/coverage.svg

          git add badges/coverage.svg
          git commit -m "chore: update coverage badge [skip ci]" || echo "No changes to commit"
          git push origin HEAD:coverage-badges --force

      # -------------------------------
      # Upload badge as artifact
      # -------------------------------
      - name: Upload coverage badge as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: badges/coverage.svg

      # -------------------------------
      # Deploy Angular site to cd-portfolio
      # -------------------------------
      - name: Deploy to cd-portfolio
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: "dist/WebsitePortfolio/browser"
          destination-github-username: "czar-ec"
          destination-repository-name: "cd-portfolio"
          user-email: "czar.echavez@yahoo.co.uk"
          target-branch: master
