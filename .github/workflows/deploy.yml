name: Deploy to live CD portfolio
on:
  push:
    branches: [develop]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      # set up tests
      - run: yarn install

      # run tests
      - run: yarn test:ci

      # build
      - run: yarn build:prod

      # Extract overall coverage percentage from lcov
      - name: Get coverage percentage
        id: coverage
        run: |
          COVERAGE=$(grep -A 1 "TOTAL" coverage/lcov.info | grep -oP "(?<=\s)\d+(?=\.\d+%)" | tail -1)
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      # Generate a badge (using shields.io style SVG generator)
      - name: Generate coverage badge
        run: |
          mkdir -p badges
          COLOR=red
          if [ ${{ steps.coverage.outputs.coverage }} -ge 90 ]; then COLOR=brightgreen; fi
          if [ ${{ steps.coverage.outputs.coverage }} -ge 85 ] && [ ${{ steps.coverage.outputs.coverage }} -lt 90 ]; then COLOR=green; fi
          if [ ${{ steps.coverage.outputs.coverage }} -ge 80 ] && [ ${{ steps.coverage.outputs.coverage }} -lt 85 ]; then COLOR=yellow; fi
          echo "Generating badge for coverage ${{ steps.coverage.outputs.coverage }}% ($COLOR)"
          curl -o badges/coverage.svg "https://img.shields.io/badge/coverage-${{ steps.coverage.outputs.coverage }}%25-$COLOR"

      # Commit the badge to the repo
      - name: Commit coverage badge
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add badges/coverage.svg
          git commit -m "chore: update coverage badge [skip ci]" || echo "No changes to commit"
          git push

      # deploy to cd-portfolio repo
      - name: Pushes to another repository
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: "dist/WebsitePortfolio/browser"
          destination-github-username: "czar-ec"
          destination-repository-name: "cd-portfolio"
          user-email: "czar.echavez@yahoo.co.uk"
          target-branch: master
